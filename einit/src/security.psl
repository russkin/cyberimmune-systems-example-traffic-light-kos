/* Security configuration of the "traffic light" example. */
/* nk.basic._ is required for comparison operations support in policies, like != below */
use nk.basic._

/* Definition of the execute interface. */
execute: kl.core.Execute

/* Import the file with the declaration of basic security policy aliases. */
use nk.base._

/* Declaration of entities. */
use EDL Einit
use EDL kl.core.Core
use EDL kl.VfsNet
use EDL kl.drivers.BSP
use EDL kl.drivers.GPIO
use EDL client.Client
use EDL server.Server

use EDL traffic_light.ControlSystem
use EDL traffic_light.LightsGPIO
use EDL traffic_light.Diagnostics

/* Execution of entities allowed. */
execute {
    grant ()
}

/* Request messages allowed. */
request src=traffic_light.ControlSystem {
    grant ()
}


request src=traffic_light.ControlSystem dst=kl.core.Core {
    grant ()
}

/*
request src=traffic_light.ControlSystem 
    dst=traffic_light.LightsGPIO 
    endpoint=lightsGpio.mode 
    method=FMode {
        grant()
}
*/


request src=traffic_light.ControlSystem 
    dst=traffic_light.LightsGPIO 
    endpoint=lightsGpio.mode 
    method=FMode {
        assert(bool.any([
            message.value == 0x10c,
            message.value == 0x102,
            message.value == 0x101,
            message.value == 0x301,
            message.value == 0x401,
            message.value == 0xc01,
            message.value == 0x201,
            message.value == 0x103,
            message.value == 0x104,
        ]))
}


request src=Einit {
    grant ()
}

request src=kl.core.Core {
    grant ()
}

request src=traffic_light.LightsGPIO dst=kl.core.Core {
    grant ()
}

request src=traffic_light.Diagnostics dst=kl.core.Core {
    grant ()
}

request src=traffic_light.LightsGPIO
    dst=traffic_light.Diagnostics
    endpoint=diagnostics.report
    method=report {
        grant()
}


/* Response messages allowed. */
response {
    grant ()
}

/*
response src=traffic_light.LightsGPIO 
    dst=traffic_light.ControlSystem 
    endpoint=lightsGpio.mode 
    method=FMode {
        assert (message.result < 0x1000404)
}
*/

error {
    grant ()
}

/* Calls to the security interface are ignored. */
security {
    grant ()
}

/**
 * Allows the tasks with the Einit class to start the tasks with the kl.VfsNet class.
 */
execute src=Einit, dst=kl.VfsNet
{
    grant()
}

/**
 * Allows the tasks with the kl.VfsNet class to send requests to the KasperskyOS kernel and get
 * responses. This enables the VfsNet program to use core endpoints.
 */
request src=kl.VfsNet, dst=kl.core.Core
{
    grant()
}

response src=kl.core.Core, dst=kl.VfsNet
{
    grant()
}

/**
 * Allows the tasks with the Einit class to start the tasks with the client.Client class.
 */
execute src=Einit, dst=client.Client
{
    grant()
}

/**
 * Allows the tasks with the Einit class to start the tasks with the server.Server class.
 */
execute src=Einit, dst=server.Server
{
    grant()
}

request src=client.Client, dst=kl.core.Core
{
    grant()
}

response src=kl.core.Core, dst=client.Client
{
    grant()
}

/**
 * Allows the tasks with the server.Server class to send requests to the KasperskyOS kernel and get
 * responses. This enables the Server program to use core endpoints.
 */
request src=server.Server, dst=kl.core.Core
{
    grant()
}

response src=kl.core.Core, dst=server.Server
{
    grant()
}

/**
 * Allows the tasks with the client.Client class to send requests
 * to tasks with the kl.VfsNet class and get responses.
 * This enables the Client program to communicate with the VfsNet program.
 */
request src=client.Client, dst=kl.VfsNet
{
    grant()
}


/**
 * Allows the tasks with the server.Server class to send requests
 * to tasks with the kl.VfsNet class and get responses.
 * This enables the Server program to communicate with the VfsNet program.
 */
request src=server.Server, dst=kl.VfsNet
{
    grant()
}

response src=kl.VfsNet, dst=server.Server
{
    grant()
}

response src=kl.VfsNet, dst=client.Client
{
    grant()
}


/**
 * Allows the tasks with the traffic_light.Diagnostics class to send requests
 * to tasks with the kl.VfsNet class and get responses.
 * This enables the Client program to communicate with the VfsNet program.
 */
request src = traffic_light.Diagnostics, dst = kl.VfsNet
{
    grant()
}

response src = kl.VfsNet, dst = traffic_light.Diagnostics
{
    grant()
}

/**
 * Allows the tasks with the kl.drivers.BSP class to send requests to the
 * KasperskyOS kernel and get responses. This enables the BSP driver to use
 * core endpoints.
 */
request src = kl.drivers.BSP, dst = kl.core.Core
{
    grant()
}

response src = kl.core.Core, dst = kl.drivers.BSP
{
    grant()
}

execute src=Einit, dst=kl.drivers.GPIO
{
    grant()
}

/**
 * Allows the tasks with the kl.drivers.GPIO class
 * to send requests to the KasperskyOS kernel and get responses.
 * This enables the GPIO program to use core endpoints.
 */
request src = kl.drivers.GPIO, dst = kl.core.Core
{
    grant()
}

response src = kl.core.Core, dst = kl.drivers.GPIO
{
    grant()
}

