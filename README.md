# Домашнее задание №1

1. Изменить политики безопасности так, чтобы не допустить комбинации «два зелёных».
1. Изменить политики безопасности так, чтобы не допустить вариант «два зелёных» в сочетании с другими цветами.

# Дано
1. За включение конекретного цвета светофора отвечают флаги:
    1. Карасный - `0x1`
    1. Желтый - `0x2`
    1. Зеленый - `0x4`
1. За включение "мигающего" сигнала отвечает флаг `0x8`
1. Загорающиеся на светофоре сигналы соответствуют коминации (битовое "или") выставленных флагов
1. Конфигцрация светофоров двух "поперечных" направлений представляется формулой `x << 8 | y`, где `x` - конфигурация светофора в одном направлении, а `y` - конфигурация светофора в "поперечном" направлении. 

# Решение
Для одного светофора доступны следующие комбинации (назовем его множеством `A`):
```
0x0
0x1
0x2
0x3
0x4
0x5
0x6
0x7
0x8
0x9
0xa
0xc
0xb
0xd
0xe
0xf
```

Тогда список возможных конфигураций двух светофоров можно представить следующим образом (назовем его множеством `B`):
```
0x0
0x1
0x2
0x4
0x3
0x5
0x6
0x7
0x8
0x9
0xa
0xc
0xb
0xd
0xe
0xf
0x100
0x101
0x102
0x104
0x103
0x105
0x106
0x107
0x108
0x109
0x10a
0x10c
0x10b
0x10d
0x10e
0x10f
0x200
0x201
0x202
0x204
0x203
0x205
0x206
0x207
0x208
0x209
0x20a
0x20c
0x20b
0x20d
0x20e
0x20f
0x400
0x401
0x402
0x404
0x403
0x405
0x406
0x407
0x408
0x409
0x40a
0x40c
0x40b
0x40d
0x40e
0x40f
0x300
0x301
0x302
0x304
0x303
0x305
0x306
0x307
0x308
0x309
0x30a
0x30c
0x30b
0x30d
0x30e
0x30f
0x500
0x501
0x502
0x504
0x503
0x505
0x506
0x507
0x508
0x509
0x50a
0x50c
0x50b
0x50d
0x50e
0x50f
0x600
0x601
0x602
0x604
0x603
0x605
0x606
0x607
0x608
0x609
0x60a
0x60c
0x60b
0x60d
0x60e
0x60f
0x700
0x701
0x702
0x704
0x703
0x705
0x706
0x707
0x708
0x709
0x70a
0x70c
0x70b
0x70d
0x70e
0x70f
0x800
0x801
0x802
0x804
0x803
0x805
0x806
0x807
0x808
0x809
0x80a
0x80c
0x80b
0x80d
0x80e
0x80f
0x900
0x901
0x902
0x904
0x903
0x905
0x906
0x907
0x908
0x909
0x90a
0x90c
0x90b
0x90d
0x90e
0x90f
0xa00
0xa01
0xa02
0xa04
0xa03
0xa05
0xa06
0xa07
0xa08
0xa09
0xa0a
0xa0c
0xa0b
0xa0d
0xa0e
0xa0f
0xc00
0xc01
0xc02
0xc04
0xc03
0xc05
0xc06
0xc07
0xc08
0xc09
0xc0a
0xc0c
0xc0b
0xc0d
0xc0e
0xc0f
0xb00
0xb01
0xb02
0xb04
0xb03
0xb05
0xb06
0xb07
0xb08
0xb09
0xb0a
0xb0c
0xb0b
0xb0d
0xb0e
0xb0f
0xd00
0xd01
0xd02
0xd04
0xd03
0xd05
0xd06
0xd07
0xd08
0xd09
0xd0a
0xd0c
0xd0b
0xd0d
0xd0e
0xd0f
0xe00
0xe01
0xe02
0xe04
0xe03
0xe05
0xe06
0xe07
0xe08
0xe09
0xe0a
0xe0c
0xe0b
0xe0d
0xe0e
0xe0f
0xf00
0xf01
0xf02
0xf04
0xf03
0xf05
0xf06
0xf07
0xf08
0xf09
0xf0a
0xf0c
0xf0b
0xf0d
0xf0e
0xf0f
```
Из данного списка по условиям задания необходимо исключить случаи, в которых горят одновременно два зеленых светофора в "поперечных" направлениях. Это следующие комбинации (`C`):
```
0x404
0x405
0x406
0x407
0x40c
0x40d
0x40e
0x40f
0x504
0x505
0x506
0x507
0x50c
0x50d
0x50e
0x50f
0x604
0x605
0x606
0x607
0x60c
0x60d
0x60e
0x60f
0x704
0x705
0x706
0x707
0x70c
0x70d
0x70e
0x70f
0xc04
0xc05
0xc06
0xc07
0xc0c
0xc0d
0xc0e
0xc0f
0xd04
0xd05
0xd06
0xd07
0xd0c
0xd0d
0xd0e
0xd0f
0xe04
0xe05
0xe06
0xe07
0xe0c
0xe0d
0xe0e
0xe0f
0xf04
0xf05
0xf06
0xf07
0xf0c
0xf0d
0xf0e
0xf0f
```
Но, злоумышленник через скомпрометированную систему может отправлять не только допустимые сигналы каждому светофору, а например `0xffff`. Таким образом, множество `B` необходимо расширить до множества `B'` числами из интервала [`0x404` .. `0xffff`], удовлетворяющими условию `x & 0x404 == 0x404`. Всего таких чисел достаточтно много (`16384`), но сгененрировть их можно простым алгоритмом на Python:
```python
for x in range(256):
    for y in range(256):
        z = x << 8 | y
        if (z & 0x404 == 0x404):
            print(hex(z))
```
Именно их и необходимо исключить в политике безопасности.
Они описываются общим правилом вида `assert(message.value & 0x404 == 0x404)`, но, к сожалению, я пока не нашел возможности использовать битовые операции в `psl` файлах. Список получился большим и добавление "в лоб" всех запрещенных комбинаций в политику приводит к ошибки компиляции.

Руководствуюясь принципом `default deny` следовало бы включить в политику только разрешенные правила (множество `D`):
```
0x0
0x1
0x2
0x4
0x3
0x5
0x6
0x7
0x8
0x9
0xa
0xc
0xb
0xd
0xe
0xf
0x100
0x101
0x102
0x104
0x103
0x105
0x106
0x107
0x108
0x109
0x10a
0x10c
0x10b
0x10d
0x10e
0x10f
0x200
0x201
0x202
0x204
0x203
0x205
0x206
0x207
0x208
0x209
0x20a
0x20c
0x20b
0x20d
0x20e
0x20f
0x400
0x401
0x402
0x403
0x408
0x409
0x40a
0x40b
0x300
0x301
0x302
0x304
0x303
0x305
0x306
0x307
0x308
0x309
0x30a
0x30c
0x30b
0x30d
0x30e
0x30f
0x500
0x501
0x502
0x503
0x508
0x509
0x50a
0x50b
0x600
0x601
0x602
0x603
0x608
0x609
0x60a
0x60b
0x700
0x701
0x702
0x703
0x708
0x709
0x70a
0x70b
0x800
0x801
0x802
0x804
0x803
0x805
0x806
0x807
0x808
0x809
0x80a
0x80c
0x80b
0x80d
0x80e
0x80f
0x900
0x901
0x902
0x904
0x903
0x905
0x906
0x907
0x908
0x909
0x90a
0x90c
0x90b
0x90d
0x90e
0x90f
0xa00
0xa01
0xa02
0xa04
0xa03
0xa05
0xa06
0xa07
0xa08
0xa09
0xa0a
0xa0c
0xa0b
0xa0d
0xa0e
0xa0f
0xc00
0xc01
0xc02
0xc03
0xc08
0xc09
0xc0a
0xc0b
0xb00
0xb01
0xb02
0xb04
0xb03
0xb05
0xb06
0xb07
0xb08
0xb09
0xb0a
0xb0c
0xb0b
0xb0d
0xb0e
0xb0f
0xd00
0xd01
0xd02
0xd03
0xd08
0xd09
0xd0a
0xd0b
0xe00
0xe01
0xe02
0xe03
0xe08
0xe09
0xe0a
0xe0b
0xf00
0xf01
0xf02
0xf03
0xf08
0xf09
0xf0a
0xf0b
```
В данном случае список разрешенных состояний получается меньше, и защитит от атак вида `0xffff`.

[Скрипт](control_system/src/gen.py) генерации элементов множества получился чуть больше, но тоже не очень сложный.
Правило в политике должно выглядеть следующим образом:
```psl
request src=traffic_light.ControlSystem 
    dst=traffic_light.LightsGPIO 
    endpoint=lightsGpio.mode 
    method=FMode {
        assert(bool.any([
            message.value == 0x0,
            message.value == 0x1,
            ...
            message.value == 0xf0b 
        ]))
}
```

Исключение не разумных комбинаций (например, включены все сигналы светофора) позволит уменьшить количество разрешенных конфигураций, но согласно задания необходимо исключить только комбинации, в которых горят два зеленых сигнала светофора.